library(testthat)
library(antigen.garnish)
library(data.table)
library(magrittr)
library(dt.inflix)

testthat::test_that("garnish_predictions_worker", {
  # load test data
  dt <- structure(list(var_uuid = c("723c3b52-7c95-11e7-a700-12577141430a",
  "f02510f8-fc34-4309-978a-b059640bb367", "a39bf028-dfef-41b5-9198-1192a1a74825",
  "723c3b52-7c95-11e7-a700-12577141430a", "f02510f8-fc34-4309-978a-b059640bb367",
  "a39bf028-dfef-41b5-9198-1192a1a74825"),
  pep_type = c("wt", "wt", "wt",
               "mutnfs", "mutnfs", "mutnfs"),
  pep_base = c("MAEFSQKQRKQSGSEGLGSVVDFLLANARLVLGVGGAAVLGIATLAVKRLIDRATSPPDEDDTKGDSWKELSLLRATSPQKPQPPPAAFSQPLATGSPSPSVPVEPTPIHSPTTPKFSTIAPLCLTFQERLLAFERKHVITPEAHVTLAKQLAGDIALELQAYLRSKFPELPFGALVPGGPLYDGLQAGTAEHVRLLAPLELEPGLWSLVPGVDTVAREPRCWAVRRTQLEFHPRGCSPWDRFLVGGYLSSRVLLELLRKALSASVNWPAIGSLLGCLIWPDVASEELLLKVQHECLEFTLAVLMVVPGASTDDRLLLAWPLEGLASNLWLQDLYPVETARLRALDDQDAGTRRRLLLLLCGICRGHPALVRLGWSHLTQVVLHLGEEEVAWTEEALGERFLQALEFLVGSLEQASLPCHFNPSVNLLGNFREEEIDDIGYVLYSGLQVPESLF",
  "MAAASGYTDLREKLKSMTSRDNYKAGSREAAAAAAAAVAAAAAAAAAAEPYPASGTTKRKYQEDSDPERSDYEEHQLQKEEEARKVKSGIRQIRLFSQDECSKIEARIDEVVSRAEKGLYNEHTVDRAPLRNKYFFGEGYTYGAQLQKRGPGQERLYPPGDVDEIPDWVHQLVIQKLVEHRVIPEGFVNSAVINDYQPGGCIVSHVDPIHIFERPIVSVSFFSDSALCFGCKFQFKPIRVSEPVLSLPVRRGSVTVLSGYAADEITHCIRPQDIKERRAVIILRKTRLDAPRLETKSLSSSTLPPSYASDRLSGNTRDPALKPKRSHRKADPDAAHRPRILEMDKEENRRSVLLPTHRRRGSFSSENYWRKSYESSEDCPEAASSPTRKVKMRRH",
  "MALGGALALALALALAVLGPLSLRVLAGDCKGQRQVLREAPGFVTDGAGNYSVNGNCEWLIEAPSPQHRILLDFLFLDTECTYDYLFVYDGDSPQGPLLASLSGSTRPPPIEASSGKMLLHLFSDANYNLLGFNASFRFSLCPGGCQNHGQCKSPGVCVCEPGWGGPDCGLQECSAYCGSHGTCASTLGPCRCEPGFLGRACDLHLWENQGAGWWHSVSAGDPAFSARIGAAGAFLSPPGLLAVFGGQDLNKALGDLVLYNFSTNTWESWDLTPAPAARHSHVAVAWAGLLVLMGGELANGLLTNDVWAFSPLGGGHWELLAPPASSSSGPPGLAGHAAALVDDIWLYVSGGRTQHDLFSSGLFRFRLDHTSRGYWEQVIPAGGRPPAATGHSMVFHAPSRTLLVHGGHRPSTARFSVRVNSTELFHVERRVWTTLKGRDGLQGPRERAFHTASVLGNYMVVYGGNVHTHYQEEKCYEDGIFFYHLGCHQWVSGAELAPPGTPEGRAAPPSGRYSHVAAVLGGSVLLVAGGYSGRPRGDLMAYKVPPFVFQAPALDYHLDYCSMYTDHSVCSRDPECSWCQGACQAAPPPGTPSGACPAASCLGLGRLLSDCQACLAFSSPTAPPRGPGALGWCVHNESCLPRPEQARCRGEQISGTVGWWGPAPVFVTSLEACVTQSFLPGLHLLTFQQPPNASQPDKVSIVRSTTITLTPSPETDVSLVYRGFIHPLLPGGPGGPGAEDVAVWARAQRLHVLARMARGPDTENMEEVGRWVAQQEKETRRLQRPGSDRLFPLPGRGNKYAVEIRGQLNGSAGPGHSELTLLWDRTGVPGGSEISFFFLEPYRSSACTSYSSCLGCLADQGCGWCLNSATCHLRQGRAHCEDDGSGESLLVLVPALCPLCEEHRDCHACTQDPFCEWHQSTNRKGDAACSRRGRGRGALKNPEECPPLCSQRLTCEDCLANSSQCAWCQSTHTCFLFAAYLARYPHGGCRGWDDSVHSEPRCRSCGGFLTCHECLQSHECGWCGNEDNPTLGRCLQGDFSGPLGGGNCSLWVGEGLGLPVALPARWAYARCPDVDECRLGLARCHPRATCLNTPLSYECHCQRGYQGDGITHCNRTCLEDCGHGVCSGPPDFTCVCDLGWTSDLPPPTPAPGPPAPRCSRDCGCSFHSHCRRRGPGYCDECQDWTWGEHCERCRPGSFGNATGSGGCRPCQCNGHGDPRRGHCDNLTGLCFCQDHTEGAHCQICSPGYYGDPRAGGSCFRECGGRALLTNVSSVALGSRRFGGLLPPGGGAARAGPGLSYCVWVVSATEALQPCVPGTLCPPLTLTFSPDSSTPCTLSYVLAFDGFPRFLDTGVVQSDRSLIAAFCGQRRDRPLTVQALSGLLVLHWEANGSSSWGFNASVGSARCGSGGPGSCPVPQECVPQDGAAGAGLCRCPQGWAGPHCRMALCPENCNAHTGAGICNQSLGVCICAEGFGGPDCATKLDGGQLVWETLMDSRLSADTASRFLHRLGHTMVEGPDATLWMFGGLGLPQGLLGNLYRYSVSERRWTQMLAGAEDGGPGPSPRSFHAAAYVPAGRGAMYLLGGLTAGGVTRDFWVLNLTTLQWRQEKPPQNMELPAVAGHTLTARRGLSLLLVGGYSPENGFNQQLLEYQLATGTWVSGAQSGTPPTGLYGHSAVYHEATDSLYVFGGFRFHVELAAPSPELYSLHCPDRTWSLLAPSQGAKPRPRLFHASALLGDTMVVLGGRSDPDEFSSDVLLYQVNCNTWLLPALTRPAFVGSPMEESVAHAVAAVGSRLYISGGFGGVALGRLLALTLPPDPCRLLPSPEACNQSGACTWCHGACLSGDQAHRLGCGVPPCSPMPRSPEECRRLRTCSECLARHPRTLQPGDGEASIPRCKWCTNCPEGACIGRNGSCTSENDCRINQREVFWAGNCSEAACGAADCEQCTREGKCMWTRQFKRTGETRRILSVQPTYDWTCFSHSLLNVSPMPVESSPPLPCPTPCHLLPNCTSCLASKGADGGWQHCVWSSSLQQCLSPSYLPLRCMAGGCGRLLRGPESCSLGCAQATQCALCLRRPHCGWCAWGGQDGGGHCMEGGLSGPRDGLTCGRPGASWAFLSCPPEDECANGHHDCNETQNCHDQPHGYECSCKTGYTMDNVTGVCRPVCAQGCVNGSCVEPDHCRCHFGFVGRNCSTECRCNRHSECAGVGAQDHCLLCRNHTKGSHCEQCLPLFVGSALGGGTCRPCHAFCRGNSHVCVSRKELEMARKEPEKYSLDPEEIETWVAEGPSEDEAVCVNCQNNSYGDRCESCLHGYFLLDGKCTKCQCNGHADTCNEQDGTGCPCQNNTETGTCQGSSPSDRRDCYKYQCAKCRESFHGSPLGGQQCYRLISVEQECCLDPTSQTNCFHEPKRRALGPGRTVLFGVQPKFTNVDIRLTLDVTFGAVDLYVSTSYDTFVVRVAPDTGVHTVHIQPPPPPPPPPPPADGVPRVAADLGGLGTGSGSGSPVEPRVREVWPRGLITYVTVTEPSAVLVVRSVRDRLVITYPHEHHALKSSRFYLLLLGVGDPNGPGANGSADSQGLLFFRQDQAHIDLFVFFSVFFSCFFLFLSLCVLLWKAKQALDQRQEQRRHLQEMTKMASRPFAKVTVCFPPDPAGPAPAWKPAGLPPPAFRRSEPFLAPLLLTGAGGPWGPMGGGCCPPALPATTAGLRAGPITLEPTEDGMAGVATLLLQLPGGPHAPNGACLGSALVTLRHRLHEYCGGSGGAGGSGHGGGGGRKGLLSQDNLTSMSL",
  "MAEFSQKQRKQSGSEGLGSVVDFLLANARLVLGVGGAAVLGIATLAVKRLIDRATSPPDEDDTKGDSWKELSLLRATSPQKPQPPPAAFSQPLATGSPSPSVPVEPTPIHSPTTPKFSTIAPLCLTFQERLLAFERKHVITPEAHVTLAKQLAGDIALELQAYLRSKFPELPFGALVPGGPLYDGLQAGTAEHVRLLAPLELEPGLWSLVPGVDTVAREPRCWAVRRTQLEFHPRGCSPRDRFLVGGYLSSRVLLELLRKALSASVNWPAIGSLLGCLIWPDVASEELLLKVQHECLEFTLAVLMVVPGASTDDRLLLAWPLEGLASNLWLQDLYPVETARLRALDDQDAGTRRRLLLLLCGICRGHPALVRLGWSHLTQVVLHLGEEEVAWTEEALGERFLQALEFLVGSLEQASLPCHFNPSVNLLGNFREEEIDDIGYVLYSGLQVPESLF",
  "MAAASGYTDLREKLKSMTSRDNYKAGSREAAAAAAAAVAAAAAAAAAAEPYPASGTTKRKYQEDSDPERSDYEEHQLQKEEEARKVKSGIRQIRLFSQDECSKIEARIDEVVSRAEKGLYNEHTVDRAPLRNKYFFGEGYTYGAQLQKRGPGQERLYPPGDVDEIPDWVHQLVIQKLVEHRVIPEGFVNSAVINDYQPGGCIVSHVDPIHIFERPIVSVSFFSDSALCFGCKFQFKPIRVSEPVLSLPVRRGSVTVLSGYAADEITHCIRPQDIKERRAVIILRKTRLDAPRLETKSLSSSTLPPSYASDRLSGNTRDPALKPKRSHRKADPDAAHRPRILEMDKEENRRSVLLPTHRRRGSFSSENYWRKAYESSEDCPEAASSPTRKVKMRRH",
  "MALGGALALALALALAVLGPLSLRVLAGDCKGQRQVLREAPGFVTDGAGNYSVNGNCEWLIEAPSPQHRILLDFLFLDTECTYDYLFVYDGDSPQGPLLASLSGSTRPPPIEASSGKMLLHLFSDANYNLLGFNASFRFSLCPGGCQNHGQCKSPGVCVCEPGWGGPDCGLQECSAYCGSHGTCASTLGPCRCEPGFLGRACDLHLWENQGAGWWHSVSAGDPAFSARIGAAGAFLSPPGLLAVFGGQDLNKALGDLVLYNFSTNTWESWDLTPAPAARHSHVAVAWAGLLVLMGGELANGLLTNDVWAFSPLGGGHWELLAPPASSSSGPPGLAGHAAALVDDIWLYVSGGRTQHDLFSSGLFRFRLDHTSRGYWEQVIPAGGRPPAATGHSMVFHAPSRTLLVHGGHRPSTARFSVRVNSTELFHVERRVWTTLKGRDGLQGPRERAFHTASVLGNYMVVYGGNVHTHYQEEKCYEDGIFFYHLGCHQWVSGAELAPPGTPEGRAAPPSGRYSHVAAVLGGSVLLVAGGYSGRPRGDLMAYKVPPFVFQAPALDYHLDYCSMYTDHSVCSRDPECSWCQGACQAAPPPGTPSGACPAASCLGLGRLLSDCQACLAFSSPTAPPRGPGALGWCVHNESCLPRPEQARCRGEQISGTVGWWGPAPVFVTSLEACVTQSFLPGLHLLTFQQPPNASQPDKVSIVRSTTITLTPSPETDVSLVYRGFIHPLLPGGPGGPGAEDVAVWARAQRLHVLARMARGPDTENMEEVGRWVAQQEKETRRLQRPGSDRLFPLPGRGNKYAVEIRGQLNGSAGPGHSELTLLWDRTGVPGGSEISFFFLEPYRSSACTSYSSCLGCLADQGCGWCLNSATCHLRQGRAHCEDDGSGESLLVLVPALCPLCEEHRDCHACTQDPFCEWHQSTNRKGDAACSRRGRGRGALKNPEECPPLCSQRLTCEDCLANSSQCAWCQSTHTCFLFAAYLARYPHGGCRGWDDSVHSEPRCRSCGGFLTCHECLQSHECGWCGNEDNPTLGRCLQGDFSGPLGGGNCSLWVGEGLGLPVALPARWAYARCPDVDECRLGLARCHPRATCLNTPLSYECHCQRGYQGDGITHCNRTCLEDCGHGVCSGPPDFTCVCDLGWTSDLPPPTPAPGPPAPRCSRDCGCSFHSHCRRRGPGYCDECQDWTWGEHCERCRPGSFGNATGSGGCRPCQCNGHGDPRRGHCDNLTGLCFCQDHTEGAHCQICSPGYYGDPRAGGSCFRECGGRALLTNVSSVALGSRRFGGLLPPGGGAARAGPGLSYCVWVVSATEALQPCVPGTLCPPLTLTFSPDSSTPCTLSYVLAFDGFPRFLDTGVVQSDRSLIAAFCGQRRDRPLTVQALSGLLVLHWEANGSSSWGFNASVGSARCGSGGPGSCPVPQECVPQDGAAGAGLCRCPQGWAGPHCRMALCPENCNAHTGAGICNQSLGVCICAEGFGGPDCATKLDGGQLVWETLMDSRLSADTASRFLHRLGHTMVEGPDATLWMFGGLGLPQGLLGNLYRYSVSERRWTQMLAGAEDGGPGPSPRSFHAAAYVPAGRGAMYLLGGLTAGGVTRDFWVLNLTTLQWRQEKPPQNMELPAVAGHTLTARRGLSLLLVGGYSPENGFNQQLLEYQLATGTWVSGVQSGTPPTGLYGHSAVYHEATDSLYVFGGFRFHVELAAPSPELYSLHCPDRTWSLLAPSQGAKPRPRLFHASALLGDTMVVLGGRSDPDEFSSDVLLYQVNCNTWLLPALTRPAFVGSPMEESVAHAVAAVGSRLYISGGFGGVALGRLLALTLPPDPCRLLPSPEACNQSGACTWCHGACLSGDQAHRLGCGVPPCSPMPRSPEECRRLRTCSECLARHPRTLQPGDGEASIPRCKWCTNCPEGACIGRNGSCTSENDCRINQREVFWAGNCSEAACGAADCEQCTREGKCMWTRQFKRTGETRRILSVQPTYDWTCFSHSLLNVSPMPVESSPPLPCPTPCHLLPNCTSCLASKGADGGWQHCVWSSSLQQCLSPSYLPLRCMAGGCGRLLRGPESCSLGCAQATQCALCLRRPHCGWCAWGGQDGGGHCMEGGLSGPRDGLTCGRPGASWAFLSCPPEDECANGHHDCNETQNCHDQPHGYECSCKTGYTMDNVTGVCRPVCAQGCVNGSCVEPDHCRCHFGFVGRNCSTECRCNRHSECAGVGAQDHCLLCRNHTKGSHCEQCLPLFVGSALGGGTCRPCHAFCRGNSHVCVSRKELEMARKEPEKYSLDPEEIETWVAEGPSEDEAVCVNCQNNSYGDRCESCLHGYFLLDGKCTKCQCNGHADTCNEQDGTGCPCQNNTETGTCQGSSPSDRRDCYKYQCAKCRESFHGSPLGGQQCYRLISVEQECCLDPTSQTNCFHEPKRRALGPGRTVLFGVQPKFTNVDIRLTLDVTFGAVDLYVSTSYDTFVVRVAPDTGVHTVHIQPPPPPPPPPPPADGVPRVAADLGGLGTGSGSGSPVEPRVREVWPRGLITYVTVTEPSAVLVVRSVRDRLVITYPHEHHALKSSRFYLLLLGVGDPNGPGANGSADSQGLLFFRQDQAHIDLFVFFSVFFSCFFLFLSLCVLLWKAKQALDQRQEQRRHLQEMTKMASRPFAKVTVCFPPDPAGPAPAWKPAGLPPPAFRRSEPFLAPLLLTGAGGPWGPMGGGCCPPALPATTAGLRAGPITLEPTEDGMAGVATLLLQLPGGPHAPNGACLGSALVTLRHRLHEYCGGSGGAGGSGHGGGGGRKGLLSQDNLTSMSL"),
  mutant_loc = c(240, 372, 1663, 240, 372, 1663)),
  class = c("data.table", "data.frame"),
  row.names = c(NA, -6L), .Names = c("var_uuid",
  "pep_type", "pep_base", "mutant_loc"))

  # run test
  dto <- garnish_predictions_worker(dt) %>% data.table::setkey(nmer)
  dto$nmer %>% sort %>% lapply(nchar) %>% unlist %>% plyr::count %>%

  testthat::expect_equal(.,
  structure(list(x = 8:15,
                 freq = c(48L, 54L, 60L,
                          66L, 72L, 78L, 84L, 90L)),
                  .Names = c("x", "freq"),
                  row.names = c(NA, -8L),
                  class = "data.frame")
  )

    })
